<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>
        body{
            font-family: 'Gotham SSm A', 'Gotham SSm B', "Verdana", sans-serif;
            font-size: .85em;
        }
        fieldset
        {
            width:250px;
        }
    </style>
</head>

<body>

    <script src="light-map.min.js"></script>
    <fieldset>

        <legend>settings</legend>

        <label for="provider">TMS provider</label><br>
        <select id="provider" onchange="onChange()" style="width: 100%">
            <option id="osm" data-url="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" data-domains="a,b,c" selected>OSM</option>
            <option id="mq" data-url="http://ttiles{s}.mqcdn.com/tiles/1.0.0/vy/sat/{z}/{x}/{y}.png" data-domains="01,02,03,04">MapQuest</option>
        </select>

        <hr>

        <label for="lat">latitude</label><br>
        <input id="lat" type="range" min="-85" max="85" step=".00001" value="0" style="width: 100%" onchange="onChange()" oninput="onChange()">

        <label for="lon">longitude</label><br>
        <input id="lon" type="range" min="-180" max='180' step=".00001" value="0" style="width: 100%" onchange="onChange()" oninput="onChange()">

        <label for="zoom">zoom level</label><br>
        <input id="zoom" type="range" min="1" max="18" step="1" value="1" style="width: 100%" onchange="onChange()" oninput="onChange()">

        <hr>

        <label for="width">width</label><br>
        <input id="width" type="range" min="1" max="1024" step="1" value="512" style="width: 100%" onchange="onChange()" oninput="onChange()">

        <label for="height">height</label><br>
        <input id="height" type="range" min="1" max="1024" step="1" value="512" style="width: 100%" onchange="onChange()" oninput="onChange()">

        <hr>
        <fieldset>

            <legend>loading status</legend>
            <progress id="progress" max="0" value="0" style="width:100%;"></progress>

        </fieldset>

        <hr>
        <button style="width:100%;" onclick="goHome()">go home</button>

        <fieldset>

            <legend>postProcess (works on loaded view)</legend>
            <input id="grain" type="checkbox" checked onchange="onChange()"><label for="grain">grain</label>
            <input id="grainAmount" type="range" min="1" max="100" step="1" value="25" style="width: 100%" onchange="onChange()" oninput="onChange()"><br>
            <input id="vignette" type="checkbox" checked onchange="onChange()"><label for="vignette">vignette</label><br>

        </fieldset>

    </fieldset>

    <script>

        function setProvider()
        {

            var e = document.getElementById("provider");
            var provider = e.options[e.selectedIndex];
            if( map.provider != provider.getAttribute( "data-url" ) )
            {
                map.dispose();
                map.provider = provider.getAttribute( "data-url" );
                map.domains = provider.getAttribute( "data-domains").split( "," );
            }

        }

        function onChange()
        {

            //sets the TMS provider
            setProvider();

            //sets the coordinates of the center of the map
            map.latitude  = document.getElementById("lat").value;
            map.longitude = document.getElementById("lon").value;
            map.zoom = document.getElementById("zoom").value;

            //sets the size of the map
            if( document.getElementById("width").value != map.width ||  document.getElementById("height").value != map.height )
            {
                map.setViewRect( 0,0, document.getElementById("width").value, document.getElementById("height").value );
            }

            map.setView();

            //post process
            if( document.getElementById( "grain").checked  )grain( document.getElementById("grainAmount").value );
            if( document.getElementById( "vignette").checked  )vignette();

        }

        function goHome()
        {
            var geoSuccess = function(position) {

                map.latitude  = document.getElementById("lat").value = position.coords.latitude;
                map.longitude = document.getElementById("lon").value = position.coords.longitude;
                map.zoom = document.getElementById("zoom").value = 18;
                map.setView();
            };
            navigator.geolocation.getCurrentPosition(geoSuccess);
        }

        //init the map
        var map = new Map( "", "", 512,512, 0, 18 );
        document.body.appendChild( map.canvas );

        //sets the TMS provider
        setProvider();

        //load the view
        onChange();

        //loading progress

        function onLoadComplete( status )
        {
            if( status==0 )
            {
                document.getElementById( "progress").max = map.loadedTiles.length;
                document.getElementById( "progress").value = map.loadedTiles.length;

            }
        }

        function onTileLoaded( tile )
        {
            document.getElementById( "progress").max = map.loadedTiles.length;
            document.getElementById( "progress").value = map.loadedTiles.length - map.tiles.length;
        }

        map.eventEmitter.on( Map.ON_LOAD_COMPLETE, onLoadComplete );
        map.eventEmitter.on( Map.ON_TILE_LOADED, onTileLoaded );


        //postprocess
        function vignette(  ) {

            var ctx = map.ctx;
            //create a vignette
            var w2 = map.width / 2;
            var grd = ctx.createRadialGradient( w2, w2, 0.000, w2, w2, w2);

            // Add colors
            grd.addColorStop(0.000, 'rgba(0, 0, 0, 0.00 )');
            grd.addColorStop(1.000, 'rgba(0, 0, 0, 0.75 )');

            // Fill with gradient
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, map.width, map.height );

        }

        function grain( noise ){

            //adding grain: computationnaly expensive, avoid in loops
            var imgData = map.ctx.getImageData(0,0,map.width, map.height );
            var data = imgData.data;
            for( var i = 0; i < data.length; i+= 4 )
            {
                var grain = ~~( (.5 - Math.random() ) * 2 * noise );
                data[ i ]       += grain;
                data[ i + 1 ]   += grain;
                data[ i + 2 ]   += grain;
            }
            imgData.data = data;
            map.ctx.putImageData( imgData, 0,0 );

        }


    </script>
</body>
</html>